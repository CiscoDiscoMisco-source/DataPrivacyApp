version: 1
backend:
  phases:
    preBuild:
      commands:
        - npm install -g @aws-amplify/cli
        - npm install
        - echo "Node version $(node -v)"
        - echo "NPM version $(npm -v)"
        - |
          # Set up AWS credentials using Amplify Secrets
          echo "Setting up AWS credentials from Amplify Secrets"
          mkdir -p ~/.aws
          
          # Access the secrets from process.env.secrets which Amplify automatically sets up
          # Create a small script to extract secrets
          cat > extract-secrets.js << 'EOF'
          const fs = require('fs');
          try {
            const secrets = JSON.parse(process.env.secrets || '{}');
            console.log('Found secrets:', Object.keys(secrets).join(', '));
            
            const accessKey = secrets.AWS_ACCESS_KEY_ID || '';
            const secretKey = secrets.AWS_SECRET_ACCESS_KEY || '';
            const region = secrets.AWS_REGION || process.env.AWS_REGION || 'us-east-1';
            
            if (accessKey && secretKey) {
              fs.writeFileSync('./aws-credentials.txt', 
                `[default]\naws_access_key_id = ${accessKey}\naws_secret_access_key = ${secretKey}\nregion = ${region}`);
              fs.writeFileSync('./aws-config.txt', 
                `[default]\nregion = ${region}`);
              console.log('AWS credential files created successfully');
            } else {
              console.log('AWS credentials not found in secrets');
            }
          } catch (error) {
            console.error('Error extracting secrets:', error.message);
          }
          EOF
          
          # Run the extraction script
          node extract-secrets.js
          
          # Use the generated files if they exist
          if [ -f "./aws-credentials.txt" ]; then
            mv ./aws-credentials.txt ~/.aws/credentials
            mv ./aws-config.txt ~/.aws/config
            chmod 600 ~/.aws/credentials
            chmod 600 ~/.aws/config
            echo "AWS credentials configured successfully"
          else
            echo "WARNING: Could not configure AWS credentials"
          fi
    build:
      commands:
        - echo "Running Amplify backend build..."
        - amplify -v || echo "amplify version command failed"
        - export DEBUG=*
        - |
          node -e "console.log('Environment variables:', JSON.stringify({
            AMPLIFY_APP_ID: process.env.AMPLIFY_APP_ID, 
            AMPLIFY_ENV_NAME: process.env.AMPLIFY_ENV_NAME
          }))"
        - aws sts get-caller-identity || echo "AWS CLI not configured properly"
        - npm run generate-outputs || echo "Failed to generate outputs, but continuing build"
        - ls -la
        - |
          if [ -f "./amplify_outputs.json" ]; then 
            echo "amplify_outputs.json exists"
          else 
            echo "WARNING: amplify_outputs.json does not exist"
          fi
frontend:
  phases:
    preBuild:
      commands:
        - npm install
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/* 